---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
winedata <- read.csv("~/Documents/senior_year/stat471/final_project/wine-reviews/winemag-data-130k-v2.csv")
```

```{r}
summary(winedata)
names(winedata)
```

remove duplicated rows:
```{r}
winedata <- winedata[,-c(1,9)]
winedata_unique = unique(winedata[,-1])
```

Take out entries with missing values in important categories:
```{r}
winedata_clean <- winedata_unique[!is.na(winedata_unique$price),]
winedata_clean <- winedata_clean[winedata_unique$country!="",]
winedata_clean <- winedata_clean[winedata_unique$description!="",]
winedata_clean.reg <- winedata_clean[winedata_unique$region_1!="",]
```

Wine is stable of modern fine dining culture and often the ones that reflect their origin or terroir garner the most praise from critics. It would be rather useful to be able to predict the variety, winery and location of wine based on description from the ciritics. This dataset is sraped from WineEnthusiast.com during the week of June 15th, 2017. Only wines with scores over 80 are kept in the dataset with nearly 13000 initial observations. 

##Data Cleaning/Summary
```{r,echo=F}
#price and Not very correlated
cor(winedata_clean$points,winedata_clean$price)
multi.hist(winedata_clean[,sapply(winedata_clean, is.numeric)])
```
First we removed the numerative column for repetitiveness, then region_2 was removed as well because of the excess amount of NA and specificity. We also removed observations with NAs in price and country because those are likely to be important predictors of sentiment. We then created a separate dataset with NAs from region_1 removed since some countries are simply to small to have regional specificity so we don't want to pollute the data. 

Wine price and points are somewhat correlated, with about 0.416 correlation coefficient. This makes sense because tasters generally try to avoid a priori knowledge about wine characteristics before tasting in order to be objective. However, the amount of effort that went into more expensively priced wine would reflect somewhat in the quality. 

Looking at the histograms of points and prices we can observe their distributional differences. While points are distributred relatively normally, prices are right-skewed with a few extremely expensive wines. 

```{r,echo=F}
winedata_clean %>% filter(taster_name!="") %>% group_by(taster_name) %>% summarise(num_wine_tasted=n()) %>% arrange(desc(num_wine_tasted))
```
There are a total of 19 wine tasters that contribute to this datasets. Most of them are rather prolific and cover thousands of wine. The most prolific of which is Roger Voss who is an editor for WineEnthusiast and covers most of France. 

```{r,echo=F}
winedata_clean %>% group_by(country) %>% summarize(mean_points=mean(points),mean_price=mean(price),n_wines_produced=n()) %>%
  arrange(desc(n_wines_produced,mean_points,mean_price))
```

```{r}
winedata_clean %>% group_by(province) %>% summarize(mean_points=mean(points),mean_price=mean(price),n_wines_produced=n()) %>%
  arrange(desc(n_wines_produced,mean_points,mean_price)) %>%
    mutate(country=winedata_clean[match(province,winedata_clean$province),1]) %>% filter(country %in% c("US","France","Italy","Spain","Portugal"),
                                                                                         n_wines_produced > 1000)
```

While mean points and mean price on a country level can tell us in some ways the general wine quality in a given country. These qualities should be taken with reservations since the countries like US and France dominate the market in terms of number of wines produced which would dilute the mean. This also implies that country would not be a good variable to predict because of the variation of wine quality across the aforementioned powerhouses of wine production. 

```{r}
winedata_clean %>% group_by(variety) %>% summarize(mean_points=mean(points),mean_price=mean(price),n_wines_produced=n()) %>%
  arrange(desc(n_wines_produced,mean_points,mean_price))
```


```{r,echo=F}
province_dat <- winedata_clean %>% group_by(province) %>% summarize(mean_points=mean(points),mean_price=mean(price)) %>%
  arrange(desc(mean_points,mean_price)) %>% 
  mutate(country=winedata_clean[match(province,winedata_clean$province),1],
         prov_country=paste(province,",",country))

province_100_dat <- winedata_clean %>% group_by(province) %>% summarize(mean_points=mean(points),mean_price=mean(price), n_wine=n()) %>%
  filter(n_wine>=100) %>%
  arrange(desc(mean_points,mean_price)) %>% 
  mutate(country=winedata_clean[match(province,winedata_clean$province),1],
         prov_country=paste(province,",",country))

ggplot(province_100_dat[1:10,],aes(mean_points,mean_price)) +
  geom_point() +
  geom_label_repel(aes(label=prov_country),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50') +
  theme_classic() +
  labs(title="Top 10 Provinces With the Highest Scores", 
       x="Mean Points", y="Mean Price")
```
Looking at provinces is a much better idea as each one in general has much similar geographical features and climate, allowing for more consistent wine quality within each categorical level. However, even provincial level aggregation may be too broad. None of the traditional wine provinces such as Burgundy, Bordeaux or Northern California made it into the top 10 average points province list. This is likely due to the large volume of wine produced in those regions which has an effect on the wine's average quality. Meanwhile small regions like Madeira (a Portuguese Atlantic island) are likely to have limited wine outputs. 
```{r,echo=F}
region_dat <- winedata_clean.reg %>% group_by(region_1) %>% summarize(mean_points=mean(points),mean_price=mean(price)) %>%
  arrange(desc(mean_points,mean_price)) %>% 
  mutate(country=winedata_clean.reg[match(region_1,winedata_clean.reg$region_1),1],
         province=winedata_clean.reg[match(region_1,winedata_clean.reg$region_1),6],
         reg_prov=paste(region_1,",",province))

ggplot(region_dat[1:10,],aes(mean_points,mean_price)) +
  geom_point() +
  geom_label_repel(aes(label=reg_prov),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50') +
  theme_classic() +
  labs(title="Top 10 Regions With the Highest Scores", 
       x="Mean Points", y="Mean Price")
```


Although the majority of observations also contain a region value, the lack of it does not necessarily guarantee that the observation is faulty since many wines are from small countries or too non-specific in its origin to warrant region specifications. On the flip side, having a regional label also does not gurantee its quality. Majority of wine-producing regions with high points are located in Burgundy. This has historical reasons. Compared to Bordeaux and other regions that place emphasis on individual chateaus or wineries, Burgundy is famous for its regional consistency as all wines made from the same area, no matter the prodoucer, is often labeled as the same variety. This speaks to Burgundian winemakers' confidence in the reputation of its terroir, or the set of all attributes of the phenotype of the land. 
```{r,echo=F}
winery_dat <- winedata_clean %>% group_by(winery) %>% summarize(mean_points=mean(points),mean_price=mean(price)) %>%
  arrange(desc(mean_points,mean_price)) %>%
  mutate(country=winedata_clean[match(winery,winedata_clean$winery),1],
         province=winedata_clean[match(winery,winedata_clean$winery),6],
         winery_prov=paste(winery,",",province))

ggplot(winery_dat[1:10,],aes(mean_points,mean_price)) +
  geom_point() +
  geom_label_repel(aes(label=winery_prov),
                   box.padding   = 0.35, 
                   point.padding = 0.3,
                   segment.color = 'grey50') +
  theme_classic() +
  labs(title="Top 10 Wineries With the Highest Scores", 
       x="Mean Points", y="Mean Price")
```

Generally European wineries charge a higher price than their Californian counterparts despite similairty in points. This reflects the higher esteem held by French wine despite the blind tasting catastrophe that it suffered during the 1976 Judgment of Paris. 

```{r}
winedata_clean %>% filter(winery!="") %>% group_by(winery) %>% summarise(num_produced=n()) %>% arrange(desc(num_produced)) %>%
  mutate(province=winedata_clean[match(winery,winedata_clean$winery),6])
```

Take a subset of data to make PCA tinkering more efficent:
```{r}
#Uncomment line below to take subset of data
#winedata_subset = sample_n(winedata,50000)
#Uncomment line below to use entire dataset instead of subset
winedata_subset = winedata_clean
dtm_ready_df = winedata_subset[ ,c(1, 2)]
```


Okay, let's create a corpus, clean it, and create a DTM!
```{r}
library(tm)
corp.original <- VCorpus(VectorSource(dtm_ready_df$description))
corp = tm_map(corp.original, removePunctuation) 
corp = tm_map(corp, removeNumbers) 
corp = tm_map(corp, content_transformer(tolower) ,lazy=TRUE) 
corp = tm_map(corp, content_transformer(removeWords), c("like") ,lazy=TRUE)
corp = tm_map(corp, content_transformer(removeWords), stopwords("english"))
corp = tm_map(corp, content_transformer(stemDocument) ,lazy=TRUE) 
corp = tm_map(corp, stripWhitespace)

# Convert to document term matrix
dtm <- DocumentTermMatrix(corp)
# Reduce matrix sparsity to better deal with LDA later on
dtms = removeSparseTerms(dtm, .995)
dtm_matrix = as.matrix(dtms)
```

Remove wines that have no description from DTM to avoid LDA errors
```{r}
rowTotals <- apply(dtm_matrix , 1, sum) #Find the sum of words in each Document
dtm_matrix   <- dtm_matrix[rowTotals> 0, ]           #remove all docs without words
```

Conduct LDA for given number of topics
```{r}
library(topicmodels)
number_of_topics = 20
ldaOut20_all <-LDA(dtm_matrix, number_of_topics, method="Gibbs")
terms(ldaOut,10)
```

The following chunk will generate the topic probilities for each document:
```{r}
dic = Terms(dtms)

# Specify this dictionary when creating the dtm for the new articles, which will limit the dtm it creates to only the words that also appeared in the archive. In the example below, 'ldaOut' would be the name assigned to the topic model we created in Step earlier.

new_dtm = DocumentTermMatrix(corp, control=list(dictionary = dic))
new_dtm = new_dtm[rowSums(as.matrix(new_dtm))!=0,]
topic_probabilities20 = posterior(ldaOut20_all, new_dtm)
```

Run this chunk to generate a dataframe that gives the highest ranked topic for each wine.
```{r}
articles_w_topics20 = as.data.frame(cbind(winedata_clean[rowTotals> 0, ], max.col(topic_probabilities20$topics)))
# Rename a column in R
colnames(articles_w_topics20)[colnames(articles_w_topics20)=="max.col(topic_probabilities20$topics)"] <- "topic"
articles_w_topics20$topic = as.factor(articles_w_topics20$topic)
```

Run this chunk to generate a dataframe that gives the probabilities of each topic for each wine.
```{r}
articles_w_topics20 = as.data.frame(cbind(winedata_clean[rowTotals> 0, ], (topic_probabilities20$topics)))
# Rename a column in R
```

Rename columns from topic numbers to topic_n naming convention. Example: from `1` to `topic_1`.
```{r}
for (i in 1:20){
  colnames(articles_w_topics20)[colnames(articles_w_topics20)==i] <- paste("topic_", i, sep="")
}
```

Constructing a function to later use to extract year from a string
```{r}
# create a helper function
yearExtract <- function(string) {
  t <- regmatches(string, regexec("[0-9]{4}", string))
  sapply(t, function(x) {
    if(length(x) > 0){
      return(as.numeric(x))
    } else {
      return(NA)    
    }
  })
}
```

Use our new function to extract the vintage year from wine title. Note, around 5% of wines don't have a year in the title and the regex match can possibly catch a 4 digit number other than year if present.
```{r}
articles_w_topics20$vintage_year = (yearExtract(as.character(articles_w_topics20$title)))
articles_w_topics20 <- articles_w_topics20[!is.na(articles_w_topics20$vintage_year),]
```

Create a new variable that is a categorical grouping of the year.
```{r}
articles_w_topics20$vintage_year_cat = NA
articles_w_topics20$vintage_year_cat[articles_w_topics20$vintage_year>=2010&articles_w_topics20$vintage_year<=2017] <- "2010-2017"
articles_w_topics20$vintage_year_cat[articles_w_topics20$vintage_year>=2000&articles_w_topics20$vintage_year<=2009] <- "2000-2009"
articles_w_topics20$vintage_year_cat[articles_w_topics20$vintage_year>=1980&articles_w_topics20$vintage_year<=1999] <- "1980-1999"
articles_w_topics20$vintage_year_cat[articles_w_topics20$vintage_year>=1950&articles_w_topics20$vintage_year<=1979] <- "1950-1979"
```

```{r}
articles_w_topics20$country_trimmed = "Other"
articles_w_topics20$country_trimmed[articles_w_topics20$country=="Italy"] <- "Italy"
articles_w_topics20$country_trimmed[articles_w_topics20$country=="France"] <- "France"
articles_w_topics20$country_trimmed[articles_w_topics20$country=="US"] <- "US"
```

Now let's create a train test split:
```{r}
set.seed(42) # Set Seed so that same sample can be reproduced in future also
# Now Selecting 80% of data as sample from total 'n' rows of the data  
sample <- sample.int(n = nrow(articles_w_topics20), size = floor(.80*nrow(articles_w_topics20)), replace = F)
train <- articles_w_topics20[sample, ]
test  <- articles_w_topics20[-sample, ]
```

PCA - not effective because topics are calculated to assume minimum correlation
```{r}
topics <- prcomp(articles_w_topics20[,c(15:34)], scale=TRUE)
round(topics$rotation, 5)

cpve <- 100*cumsum((topics$sdev)^2)/20   

# Scree plot of CPVE's
plot(seq(1:20), cpve, pch=16, ylim=c(0, 100),
     main="Cumulative Proportion of Variance Explained",
     xlab="Number of PC's Used")
```

Generate a model:
```{r}
# summary(lm(points ~ log(price)+ taster_name + topic_1 + topic_2 + topic_3 + topic_4 + topic_5 + topic_6 + topic_7 + topic_8 + topic_9 + topic_10 + topic_11 + topic_12 + topic_13 + topic_14 + topic_15 + topic_16 + topic_17 + topic_18 + topic_19 + topic_20 + topic_21 + topic_22 + topic_23 + topic_24 + topic_25 + topic_26 + topic_27 + topic_28 + topic_29 + topic_30, articles_w_topics30))

summary(lm(points ~ log(price) + taster_name + vintage_year_cat + topic_1 + topic_2 + topic_3 + topic_4 + topic_5 + topic_6 + topic_7 + topic_8 + topic_9 + topic_10 + topic_11 + topic_12 + topic_13 + topic_14 + topic_15 + topic_16 + topic_17 + topic_18 + topic_19 + topic_20, train))

# Run regsubsets for model selection
subsets = regsubsets(points ~ log(price) + taster_name + country_trimmed + vintage_year_cat + topic_1 + topic_2 + topic_3 + topic_4 + topic_5 + topic_6 + topic_7 + topic_8 + topic_9 + topic_10 + topic_11 + topic_12 + topic_13 + topic_14 + topic_15 + topic_16 + topic_17 + topic_18 + topic_19 + topic_20, data=train, nvmax=50,method="backward")

#sumarize and print results
subsets.fit = summary(subsets)
subsets.fit$which
data.frame(variables = (1:length(subsets.fit$rsq)),
           r_squared = subsets.fit$rsq,
           rss = subsets.fit$rss,
           bic = subsets.fit$bic,
           cp = subsets.fit$cp)
coef(subsets,20)

plot(subsets.fit$rsq, xlab="Number of predictors", ylab="R-square", col="red", type="p", pch=16)
plot(subsets.fit$rss, xlab="Number of predictors", ylab="RSS", col="blue", type="p", pch=16)

plot(subsets.fit$cp, xlab="Number of predictors", 
     ylab="cp", col="red", type="p", pch=16)
plot(subsets.fit$bic, xlab="Number of predictors", 
     ylab="bic", col="blue", type="p", pch=16)
plot(subsets.fit$adjr2, xlab="Number of predictors", 
     ylab="adjr2", col="green", type="p", pch=16)
```

final model
```{r}
final.lm <- lm(points ~ log(price) + taster_name  + country_trimmed + topic_1 + topic_2 + topic_3 + topic_5 + topic_7 +  topic_8 + topic_10 + topic_11 + topic_14 + topic_15 + topic_17, data=train)

summary(final.lm)

test_MSE <- mean(((test$points - predict.lm(final.lm, test))^2),na.rm = TRUE)
test_MSE
```

topic 1: toasty, spicy taste (coffee-like)
topic 2: strong, tart flavor (acidic)
topic 3: soft, fruity flavor (fruit juice)
topic 5: blend of grape variety
topic 7: complex flavor and after taste
topic 8: creamy, rich taste (vanilla, caramel like)
topic 10: ripe fruits/full body taste
topic 11: herbal, earthy taste
topic 14: berries
topic 15: good balance of alcoholic and non-alcoholic qualities
topic 17: interaction of different tastes


```{r}
terms(ldaOut20_all,15)
```



