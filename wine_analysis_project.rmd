##Reading the data
```{r}
knitr::opts_chunk$set(echo = TRUE, 
                      tidy = TRUE, fig.width = 7, fig.height = 4,
                      fig.align='left', dev = 'pdf')
if(!require("pacman")) install.packages("pacman")

pacman::p_load(dplyr, ggplot2, glmnet, ggrepel, tm, wordcloud, RTextTools,
               data.table,psych)

setwd("C:/Users/george/Desktop/STAT 471/project")
wine.dat <- read.csv("winemag-data-130k-v2.csv", encoding="UTF-8",stringsAsFactors=FALSE)
```
The data was scraped from WineEnthusiast during the week of June 15th, 2017. Only wines with scores over 80 are kept in the dataset with nearly 13000 initial observations. The goal is to predict the variety, winery and location of wine based on description. 
##Data Cleaning/Summary
```{r,echo=F}
#took out wines with unknown countries or price
summary(wine.dat)
wine.dat <- wine.dat[,-c(1,9)]
wine.dat.clean <- wine.dat[!is.na(wine.dat$price),]
wine.dat.clean <- wine.dat.clean[wine.dat.clean$country!="",]
wine.dat.clean.reg <- wine.dat.clean[wine.dat.clean$region_1!="",]

#price and Not very correlated
cor(wine.dat.clean$points,wine.dat.clean$price)
multi.hist(wine.dat.clean[,sapply(wine.dat.clean, is.numeric)])
```

```{r,echo=F}
province_dat <- wine.dat.clean %>% group_by(province) %>% summarize(mean_points=mean(points),mean_price=mean(price)) %>%
  arrange(desc(mean_points,mean_price)) %>% 
  mutate(country=wine.dat.clean[match(province,wine.dat.clean$province),1],
         prov_country=paste(province,",",country))

ggplot(province_dat[1:10,],aes(mean_points,mean_price)) +
  geom_point() +
  geom_label_repel(aes(label=prov_country),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50') +
  theme_classic() +
  labs(title="Top 10 Provinces With the Highest Scores", 
       x="Mean Points", y="Mean Price")
```
Surprisingly, none of the traditional wine provinces such as Burgundy, Bordeaux or Northern California made it into this list. This is likely due to the large volume of wine produced in those regions which has an effect on the wine's average quality. 
```{r,echo=F}
region_dat <- wine.dat.clean.reg %>% group_by(region_1) %>% summarize(mean_points=mean(points),mean_price=mean(price)) %>%
  arrange(desc(mean_points,mean_price)) %>% 
  mutate(country=wine.dat.clean.reg[match(region_1,wine.dat.clean.reg$region_1),1],
         province=wine.dat.clean.reg[match(region_1,wine.dat.clean.reg$region_1),6],
         reg_prov=paste(region_1,",",province))

ggplot(region_dat[1:10,],aes(mean_points,mean_price)) +
  geom_point() +
  geom_label_repel(aes(label=reg_prov),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50') +
  theme_classic() +
  labs(title="Top 10 Regions With the Highest Scores", 
       x="Mean Points", y="Mean Price")
```
Majority of wines with high points are from specific regions in Burgundy. This has historical reasons. Compared to Bordeaux and other regions that place emphasis on individual chateaus or wineries, Burgundy is famous for its regional consistency as all wines made from the same area, no matter the prodoucer, is often labeled as the same variety. This speaks to Burgundian winemakers' confidence in the reputation of its terroir, or the set of all attributes of the phenotype of the land. 
```{r,echo=F}
winery_dat <- wine.dat.clean %>% group_by(winery) %>% summarize(mean_points=mean(points),mean_price=mean(price)) %>%
  arrange(desc(mean_points,mean_price)) %>%
  mutate(country=wine.dat.clean[match(winery,wine.dat.clean$winery),1],
         province=wine.dat.clean[match(winery,wine.dat.clean$winery),6],
         winery_prov=paste(winery,",",province))

ggplot(winery_dat[1:10,],aes(mean_points,mean_price)) +
  geom_point() +
  geom_label_repel(aes(label=winery_prov),
                   box.padding   = 0.35, 
                   point.padding = 0.3,
                   segment.color = 'grey50') +
  theme_classic() +
  labs(title="Top 10 Wineries With the Highest Scores", 
       x="Mean Points", y="Mean Price")
```

Generally European wineries charge a higher price than their californian counterparts despite similairty in points. This reflects the higher esteem held by French wine despite the blind tasting catastrophe that it suffered during the 1976 Judgment of Paris. 

```{r}
wine.dat.clean %>% filter(winery!="") %>% group_by(winery) %>% summarise(num_produced=n()) %>% arrange(desc(num_produced)) %>%
  mutate(province=wine.dat.clean[match(winery,wine.dat.clean$winery),6])
```

```{r,echo=F}
wine.dat.clean %>% filter(taster_name!="") %>% group_by(taster_name) %>% summarise(num_wine_tasted=n()) %>% arrange(desc(num_wine_tasted))
```

##Corpus Analysis
```{r}
set.seed(1)

wine.dat.sample <- wine.dat.clean[sample(1:nrow(wine.dat.clean),10000,replace=FALSE),]
wine.corpus <- VCorpus(VectorSource(wine.dat.sample$description))
wine.corpus <- tm_map(wine.corpus, content_transformer(tolower))
wine.corpus <- tm_map(wine.corpus, removeWords, stopwords("english"))
wine.corpus <- tm_map(wine.corpus, removePunctuation)
wine.corpus <- tm_map(wine.corpus, removeNumbers)
wine.corpus <- tm_map(wine.corpus, stemDocument, lazy = TRUE) 

wine.dtm <- DocumentTermMatrix(wine.corpus) 
threshold <- .01*length(wine.corpus)
wine.words <- findFreqTerms(wine.dtm, lowfreq=threshold)
wine.words[1:20]
```